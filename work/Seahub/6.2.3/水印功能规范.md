## 需求

管理员可以配置对所有外链 (图片和 PDF) 使用水印。

当用户通过外链查看或者下载图片和 PDF 的时候，会增加外链生成者的水印。这样可以追溯文件的泄露者。


| 描述 | 内部预览 | 外链预览 | 外链下载 | 实现 |  不足 |
| -------- | ---------- | ---------- | ---------- | -----------| -------- |
| 图片 | ---- | YES | YES | 直接使用pillow画在图片上 | ---- |
| PDF | ---- | YES | YES | 直接替换源文件，使得pdf2html会使用带水印的pdf生成html预览，下载的话直接使用带水印的文件返回， 水印pdf由reportlab生成pdf， pdfrw合并pdf生成| 目前不支持其他语言 |
| DOC | ---- | ---- | ---- | ---- | --- |

## 设计

### 依赖库

`libjpeg-dev`, `Pillow`, `pdfrw`, `reportlab`


If you has been install Pillow without libjpeg-dev.you can follow the steps below.
```
    # install libjpeg-dev with apt
    sudo apt-get install libjpeg-dev
    # if you're on Ubuntu 14.04, also install this
    sudo apt-get install libjpeg8-dev

    # reinstall pillow
    pip install -I --no-cache-dir -v Pillow
```

### 实现

图片: 使用Pillow将图片作为画板， 添加分享者的email画到图片的某一坐标点上。

PDF: 动态创建包含分享者email的 pdf，合并到目标的每一页pdf(对于格式不符合pdf规范，或者写权限加密的pdf，会跳过并打印到log上)。  


## 配置

是否开启水印功能  
`ENABLE_SHARE_LINK_WATERMARK = False`

水印缓存文件存放位置
`WATERMARK_PATH = os.path.join(SEAHUB_DATA_ROOT, 'watermark')`

用于预览pdf的html目标文件夹名称会以文件的obj_id加上以baes64加密的用户名和email的字符串。


## 请求过程

### 外链预览

seahub会调用rpc，来向seafevnts添加任务，之后js就每隔几秒，向seahub请求转换状态，seahub的转换状态api也是通过rpc调用seafevents的状态查询函数来实现，然后请求转换后的文件。

### 下载

seahub会获得判断缓存的文件是否存在，如果不存在，则会下载源文件，然后添加水印后保存在本地，



### api
`seahub`:  

```
https://dev.seafile.com/f/(?P<token>[a-f0-9]+):
外链预览和下载
thumbnail模块:
图片预览
```



`seafevents`:

```
在将内容写入临时文件后，会有判断是否为pdf的操作以及是否开启了水印功能。如果开启了，则对pdf进行处理。
```